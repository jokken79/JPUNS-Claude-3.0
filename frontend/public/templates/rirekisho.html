<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±¥æ­´æ›¸ - è·å‹™çµŒæ­´æ›¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LibrerÃ­a para la conversiÃ³n precisa de Romaji a Kana (Katakana/Hiragana) -->
    <script src="https://cdn.jsdelivr.net/npm/wanakana@5.3.0/umd/wanakana.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fbfcfd;
            color: #1f2937;
        }
        .container { max-width: 1200px; }
        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        input, select, textarea {
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            border-radius: 6px;
            transition: border-color 0.2s;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #1D4ED8;
            outline: none;
            box-shadow: 0 0 0 1px #1D4ED8;
        }
        .section-title {
            border-left: 5px solid #1D4ED8;
            padding-left: 1rem;
        }
        #photo_preview_container {
            width: 150px; 
            height: 180px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        #photo_preview {
            width: 100%; height: 100%; object-fit: cover;
        }
        .btn-primary {
            background-color: #1D4ED8; color: white; padding: 10px 18px;
            border-radius: 8px; font-weight: 600; transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #1E40AF; }
        .btn-secondary {
            background-color: #F3F4F6; color: #1D4ED8; padding: 10px 18px;
            border-radius: 8px; font-weight: 600; border: 1px solid #1D4ED8;
        }
        .btn-secondary:hover { background-color: #E5E7EB; }
        .ocr-upload-area {
            border: 2px dashed #d5d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .ocr-upload-area:hover {
            border-color: #1D4ED8;
            background-color: #EFF6FF;
        }
        .ocr-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
        }
        .ocr-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-weight: 600;
        }
        .ocr-status.processing { background: #DBEAFE; color: #1D4ED8; }
        .ocr-status.success { background: #D1FAE5; color: #059669; }
        .ocr-status.error { background: #FEE2E2; color: #DC2626; }
        .responsive-table { overflow-x: auto; width: 100%; }
        .responsive-table table { width: 100%; border-collapse: collapse; }
        .responsive-table th, .responsive-table td {
            padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left;
        }
        .responsive-table th {
            background-color: #DBEAFE; font-weight: 600; color: #1D4ED8;
        }
        .delete-btn {
            background-color: #fee2e2; color: #ef4444;
            border: none; border-radius: 50%;
            width: 28px; height: 28px;
            cursor: pointer; font-weight: bold;
        }
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
        }

        #preview_content {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #f1f5f9;
            overflow: auto;
        }

        #preview_content .print-page {
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
        }

        .print-page {
            width: 297mm;
            min-height: 210mm;
            background: #ffffff;
            color: #111827;
            padding: 14mm 18mm;
            box-sizing: border-box;
            font-family: 'MS Gothic', 'Yu Gothic', sans-serif;
            font-size: 9.5pt;
            line-height: 1.5;
        }

        .print-header {
            display: flex;
            gap: 12mm;
            align-items: stretch;
            margin-bottom: 10mm;
        }

        .print-photo-frame {
            width: 40mm;
            height: 50mm;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            overflow: hidden;
        }

        .print-photo-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .print-basic-table,
        .print-table {
            width: 100%;
            border-collapse: collapse;
        }

        .print-basic-table th,
        .print-basic-table td,
        .print-table th,
        .print-table td {
            border: 1px solid #000;
            padding: 3mm;
            text-align: left;
            vertical-align: top;
        }

        .print-basic-table th,
        .print-table th {
            background: #e5e7eb;
            font-weight: 600;
        }

        .print-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8mm;
            margin-bottom: 10mm;
        }

        .print-section {
            border: 1px solid #000;
            padding: 4mm;
        }

        .print-section.full-width {
            grid-column: 1 / -1;
        }

        .print-section-title {
            font-weight: 700;
            font-size: 11pt;
            margin-bottom: 3mm;
            background: #e5e7eb;
            padding: 2mm 3mm;
            border-left: 3mm solid #1D4ED8;
        }

        .print-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .print-tag {
            border: 1px solid #1D4ED8;
            background: #eef2ff;
            color: #1D4ED8;
            border-radius: 9999px;
            padding: 2px 8px;
            font-size: 8.5pt;
        }

        .print-muted {
            color: #6b7280;
            font-size: 8.5pt;
        }

        .print-table td span.block {
            display: block;
        }

        @media print {
            body { margin: 0; padding: 0; }
            #app { display: none !important; }
            #print_container { display: block !important; }
            .pdf-background { display: none !important; }
            .print-overlay { display: none !important; }
            .print-field { display: block !important; }
            .print-photo { display: block !important; }
            @page { size: A4 landscape; margin: 10mm; }
            .print-page { width: auto; min-height: auto; margin: 0; padding: 10mm; box-shadow: none; }
            .print-grid { gap: 6mm; }
            #preview_modal { display: none !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="container mx-auto">
        <header class="text-center mb-8 p-6 card rounded-xl">
            <div class="flex items-center justify-center gap-4 mb-4">
                <img src="/uns-logo.gif" alt="UNS Logo" class="h-16 w-auto object-contain">
                <div>
                    <h1 class="text-3xl font-extrabold text-blue-800">å±¥æ­´æ›¸</h1>
                    <p class="text-sm text-gray-500">UNS-ClaudeJP 2.0</p>
                </div>
            </div>
            <p class="text-lg text-gray-600">å€‹äººæƒ…å ±ãƒ»è·å‹™çµŒæ­´ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </p>
        </header>

        <main class="space-y-8">
            
            <!-- OCR Section -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">ğŸ“· æ›¸é¡OCRè‡ªå‹•å…¥åŠ›</h2>
                <p class="text-sm text-gray-600 mb-4">åœ¨ç•™ã‚«ãƒ¼ãƒ‰ã¾ãŸã¯é‹è»¢å…è¨±è¨¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€æ°åãƒ»ç”Ÿå¹´æœˆæ—¥ãƒ»ä½æ‰€ãƒ»å†™çœŸãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</p>
                
                <!-- Debug Info -->
                <div id="debug_info" class="hidden debug-info"></div>
                
                <!-- Server Status -->
                <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                    <p class="text-sm">ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="server_status" class="font-semibold">ãƒã‚§ãƒƒã‚¯ä¸­...</span></p>
                    <p class="text-sm">OCRã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: <span id="ocr_status" class="font-semibold">ãƒã‚§ãƒƒã‚¯ä¸­...</span></p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- åœ¨ç•™ã‚«ãƒ¼ãƒ‰ -->
                    <div>
                        <h3 class="font-semibold mb-2">åœ¨ç•™ã‚«ãƒ¼ãƒ‰</h3>
                        <div class="ocr-upload-area" onclick="document.getElementById('zairyu_card').click()">
                            <input type="file" id="zairyu_card" accept="image/*" class="hidden">
                            <div id="zairyu_placeholder">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                            </div>
                            <img id="zairyu_preview" class="ocr-preview hidden">
                        </div>
                        <div id="zairyu_status" class="ocr-status hidden"></div>
                    </div>
                    
                    <!-- é‹è»¢å…è¨±è¨¼ -->
                    <div>
                        <h3 class="font-semibold mb-2">é‹è»¢å…è¨±è¨¼</h3>
                        <div class="ocr-upload-area" onclick="document.getElementById('license_card').click()">
                            <input type="file" id="license_card" accept="image/*" class="hidden">
                            <div id="license_placeholder">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                            </div>
                            <img id="license_preview" class="ocr-preview hidden">
                        </div>
                        <div id="license_status" class="ocr-status hidden"></div>
                    </div>
                </div>
                
                <!-- Fallback Manual Input -->
                <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                    <p class="text-sm font-semibold text-yellow-800">OCRãŒæ©Ÿèƒ½ã—ãªã„å ´åˆ:</p>
                    <button onclick="toggleDebugMode()" class="mt-2 px-3 py-1 bg-yellow-200 text-yellow-800 rounded text-sm">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ</button>
                    <p class="text-xs text-yellow-700 mt-2">æ‰‹å‹•ã§æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã¯è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </section>

            <!-- åŸºæœ¬æƒ…å ± -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">åŸºæœ¬æƒ…å ±</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="flex-shrink-0">
                        <input type="file" id="photo_input" accept="image/*" class="hidden">
                        <label for="photo_input" id="photo_preview_container">
                            <img id="photo_preview" src="" alt="å†™çœŸ" class="hidden">
                            <div id="photo_placeholder">
                                <span class="text-4xl">ğŸ‘¤</span><br>
                                <span class="text-xs">å†™çœŸ</span>
                            </div>
                        </label>
                    </div>
                    <div class="flex-grow w-full">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">æ°å</label>
                                <input type="text" id="name_kanji" placeholder="å±±ç”° å¤ªéƒ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">ãƒ•ãƒªã‚¬ãƒŠ</label>
                                <input type="text" id="name_furigana" placeholder="ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">ID</label>
                                <input type="text" id="applicant_id" readonly class="bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">å‚™è€ƒï¼ˆOCRçµæœï¼‰</label>
                                <input type="text" id="ocr_note" readonly class="bg-gray-100 text-sm text-gray-600">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label>ç”Ÿå¹´æœˆæ—¥</label>
                                <input type="date" id="birthday">
                                <small class="text-gray-500">å½¢å¼: å¹´-æœˆ-æ—¥</small>
                            </div>
                            <div><label>å¹´é½¢</label><input type="number" id="age" min="18" max="80" readonly class="bg-gray-100"></div>
                            <div><label>æ€§åˆ¥</label>
                                <select id="gender">
                                    <option value="">é¸æŠ</option>
                                    <option value="ç”·æ€§">ç”·æ€§</option>
                                    <option value="å¥³æ€§">å¥³æ€§</option>
                                </select>
                            </div>
                            <!-- MODIFICACIÃ“N: Campo de Nacionalidad a Select Box -->
                            <div>
                                <label>å›½ç±</label>
                                <select id="nationality">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="æ—¥æœ¬">æ—¥æœ¬ (Japan)</option>
                                    <option value="ãƒ™ãƒˆãƒŠãƒ ">ãƒ™ãƒˆãƒŠãƒ  (Vietnam)</option>
                                    <option value="ãƒ–ãƒ©ã‚¸ãƒ«">ãƒ–ãƒ©ã‚¸ãƒ« (Brazil)</option>
                                    <option value="ãƒšãƒ«ãƒ¼">ãƒšãƒ«ãƒ¼ (Peru)</option>
                                    <option value="ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢ (Indonesia)</option>
                                    <option value="ãã®ä»–">ãã®ä»– (Other)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div><label>éƒµä¾¿ç•ªå·</label><input type="text" id="postal_code" placeholder="000-0000"></div>
                    <div class="md:col-span-3"><label>ä½æ‰€</label><input type="text" id="address"></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label>æºå¸¯é›»è©±</label><input type="tel" id="mobile"></div>
                    <div><label>é›»è©±ç•ªå·</label><input type="tel" id="phone"></div>
                </div>
                
                <h3 class="font-semibold mt-6 mb-3">ç·Šæ€¥é€£çµ¡å…ˆ</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label>æ°å</label><input type="text" id="emergency_name"></div>
                    <div><label>ç¶šæŸ„</label><input type="text" id="emergency_relation"></div>
                    <div><label>é›»è©±ç•ªå·</label><input type="tel" id="emergency_phone"></div>
                </div>
            </section>

            <!-- æ›¸é¡é–¢ä¿‚ -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">æ›¸é¡é–¢ä¿‚</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div><label>åœ¨ç•™è³‡æ ¼</label>
                        <select id="visa_type">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æŠ€è¡“ãƒ»äººæ–‡ãƒ»å›½éš›æ¥­å‹™">æŠ€è¡“ãƒ»äººæ–‡ãƒ»å›½éš›æ¥­å‹™</option>
                            <option value="æ°¸ä½è€…">æ°¸ä½è€…</option>
                            <option value="æ—¥æœ¬äººã®é…å¶è€…">æ—¥æœ¬äººã®é…å¶è€…</option>
                            <option value="æ°¸ä½è€…ã®é…å¶è€…ç­‰">æ°¸ä½è€…ã®é…å¶è€…ç­‰</option>
                            <option value="å®šä½è€…">å®šä½è€…</option>
                            <option value="æŠ€èƒ½å®Ÿç¿’1å·ãƒ»2å·ãƒ»3å·">æŠ€èƒ½å®Ÿç¿’1å·ãƒ»2å·ãƒ»3å·</option>
                            <option value="ç‰¹å®šæŠ€èƒ½1å·ãƒ»2å·">ç‰¹å®šæŠ€èƒ½1å·ãƒ»2å·</option>
                        </select>
                    </div>
                    <div><label>åœ¨ç•™æœŸé–“</label><input type="text" id="visa_period" placeholder="ä¾‹: 3å¹´"></div>
                    <div>
                        <label>åœ¨ç•™æœŸé–“æº€äº†æ—¥</label>
                        <input type="date" id="visa_expiry">
                        <small class="text-gray-500">å½¢å¼: å¹´-æœˆ-æ—¥</small>
                    </div>
                    <div><label>åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå·</label><input type="text" id="residence_card_no"></div>
                    <div><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·</label><input type="text" id="passport_no"></div>
                    <div>
                        <label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆæœŸé™</label>
                        <input type="date" id="passport_expiry">
                        <small class="text-gray-500">å½¢å¼: å¹´-æœˆ-æ—¥</small>
                    </div>
                    <div><label>é‹è»¢å…è¨±ç•ªå·</label><input type="text" id="license_no"></div>
                    <div><label>é‹è»¢å…è¨±ç¨®é¡</label>
                        <select id="license_type">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="åŸä»˜å…è¨±">åŸä»˜å…è¨±</option>
                            <option value="æ™®é€šå…è¨±">æ™®é€šå…è¨±</option>
                            <option value="ä¸­å‹å…è¨±">ä¸­å‹å…è¨±</option>
                            <option value="å¤§å‹å…è¨±">å¤§å‹å…è¨±</option>
                        </select>
                    </div>
                    <div>
                        <label>é‹è»¢å…è¨±æœŸé™</label>
                        <input type="date" id="license_expiry">
                        <small class="text-gray-500">å½¢å¼: å¹´-æœˆ-æ—¥</small>
                    </div>
                    <div>
                        <label>è‡ªå‹•è»Šæ‰€æœ‰</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="car_owner" value="æœ‰"> æœ‰</label>
                            <label><input type="radio" name="car_owner" value="ç„¡"> ç„¡</label>
                        </div>
                    </div>
                    <div>
                        <label>ä»»æ„ä¿é™ºåŠ å…¥</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="insurance" value="æœ‰"> æœ‰</label>
                            <label><input type="radio" name="insurance" value="ç„¡"> ç„¡</label>
                        </div>
                    </div>
                </div>
                
                <!-- Campos adicionales extraÃ­dos por OCR -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-3">OCRã§æŠ½å‡ºã•ã‚ŒãŸè¿½åŠ æƒ…å ±</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label>åœ°åŸŸ</label><input type="text" id="region" readonly class="bg-gray-100"></div>
                        <div>
                            <label>è¨±å¯å¹´æœˆæ—¥</label>
                            <input type="date" id="permission_date" readonly class="bg-gray-100">
                            <small class="text-gray-500">å½¢å¼: å¹´-æœˆ-æ—¥</small>
                        </div>
                        <div>
                            <label>ã‚«ãƒ¼ãƒ‰ç™ºè¡Œæ—¥</label>
                            <input type="date" id="issue_date" readonly class="bg-gray-100">
                            <small class="text-gray-500">å½¢å¼: å¹´-æœˆ-æ—¥</small>
                        </div>
                        <div class="md:col-span-3">
                            <label>å°±åŠ´æ´»å‹•ã®è¨±å¯</label>
                            <textarea id="authorized_activity" rows="2" readonly class="bg-gray-100"></textarea>
                        </div>
                        <div class="md:col-span-3">
                            <label>æŒ‡å®šæ›¸å°±è·æ´»å‹•ã®ç¯„å›²</label>
                            <textarea id="employer_restriction" rows="2" readonly class="bg-gray-100"></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ—¥æœ¬èªèƒ½åŠ› -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">æ—¥æœ¬èªèƒ½åŠ›ãƒ»å­¦æ­´</h2>
                <div class="responsive-table mb-4">
                    <table>
                        <thead>
                            <tr><th>é …ç›®</th><th>è©•ä¾¡</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>è©±ã™</td>
                                <td>
                                    <select id="speak_level">
                                        <option value="åˆç´š">åˆç´šï¼ˆæŒ¨æ‹¶ç¨‹åº¦ï¼‰</option>
                                        <option value="ä¸­ç´š">ä¸­ç´šï¼ˆæ—¥å¸¸ä¼šè©±ï¼‰</option>
                                        <option value="ä¸Šç´š">ä¸Šç´šï¼ˆé€šè¨³å¯ï¼‰</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>èã</td>
                                <td>
                                    <select id="listen_level">
                                        <option value="åˆç´š">åˆç´šï¼ˆæŒ¨æ‹¶ç¨‹åº¦ï¼‰</option>
                                        <option value="ä¸­ç´š">ä¸­ç´šï¼ˆæ—¥å¸¸ä¼šè©±ï¼‰</option>
                                        <option value="ä¸Šç´š">ä¸Šç´šï¼ˆé€šè¨³å¯ï¼‰</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>æ¼¢å­—èª­ã¿æ›¸ã</td>
                                <td>
                                    <select id="kanji_level">
                                        <option value="ã§ãã‚‹">ã§ãã‚‹</option>
                                        <option value="å°‘ã—">å°‘ã—</option>
                                        <option value="ã§ããªã„">ã§ããªã„</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>ã‚«ãƒŠèª­ã¿</td>
                                <td>
                                    <select id="kana_read">
                                        <option value="ã§ãã‚‹">ã§ãã‚‹</option>
                                        <option value="å°‘ã—">å°‘ã—</option>
                                        <option value="ã§ããªã„">ã§ããªã„</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>ã‚«ãƒŠæ›¸ã</td>
                                <td>
                                    <select id="kana_write">
                                        <option value="ã§ãã‚‹">ã§ãã‚‹</option>
                                        <option value="å°‘ã—">å°‘ã—</option>
                                        <option value="ã§ããªã„">ã§ããªã„</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h3 class="font-semibold mb-3">å­¦æ­´</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>æœ€çµ‚å­¦æ­´</label><input type="text" id="education" placeholder="æœ€çµ‚å­¦æ­´ã‚’å…¥åŠ›"></div>
                    <div><label>å°‚æ”»</label><input type="text" id="major" placeholder="å°‚æ”»ã‚’å…¥åŠ›"></div>
                </div>
            </section>

            <!-- èº«ä½“æƒ…å ± -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">èº«ä½“æƒ…å ±ãƒ»å¥åº·çŠ¶æ…‹</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                    <div><label>èº«é•·(cm)</label><input type="number" id="height"></div>
                    <div><label>ä½“é‡(kg)</label><input type="number" id="weight"></div>
                    <div><label>æœã®ã‚µã‚¤ã‚º</label><input type="text" id="uniform_size"></div>
                    <div><label>ã‚¦ã‚¨ã‚¹ãƒˆ(cm)</label><input type="number" id="waist"></div>
                    <div><label>é´ã‚µã‚¤ã‚º(cm)</label><input type="number" id="shoe_size"></div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div><label>è¡€æ¶²å‹</label><input type="text" id="blood_type"></div>
                    <div><label>è¦–åŠ›(å³)</label><input type="text" id="vision_right"></div>
                    <div><label>è¦–åŠ›(å·¦)</label><input type="text" id="vision_left"></div>
                    <div>
                        <label>ãƒ¡ã‚¬ãƒä½¿ç”¨</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="glasses" value="æœ‰"> æœ‰</label>
                            <label><input type="radio" name="glasses" value="ç„¡"> ç„¡</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-6 mb-4">
                    <div>
                        <label>åˆ©ãè…•</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="dominant_arm" value="å³"> å³</label>
                            <label><input type="radio" name="dominant_arm" value="å·¦"> å·¦</label>
                        </div>
                    </div>
                    <div>
                        <label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="allergy" value="æœ‰"> æœ‰</label>
                            <label><input type="radio" name="allergy" value="ç„¡"> ç„¡</label>
                        </div>
                    </div>
                    <div>
                        <label>å®‰å…¨é´æŒå‚</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="safety_shoes" value="æœ‰"> æœ‰</label>
                            <label><input type="radio" name="safety_shoes" value="ç„¡"> ç„¡</label>
                        </div>
                    </div>
                </div>
                
                <h3 class="font-semibold mb-3">ã‚³ãƒ­ãƒŠãƒ¯ã‚¯ãƒãƒ³</h3>
                <div class="flex flex-wrap gap-4">
                    <label><input type="radio" name="vaccine" value="æœªæ¥ç¨®"> æœªæ¥ç¨®</label>
                    <label><input type="radio" name="vaccine" value="1å›"> 1å›æ¥ç¨®</label>
                    <label><input type="radio" name="vaccine" value="2å›"> 2å›æ¥ç¨®</label>
                    <label><input type="radio" name="vaccine" value="3å›"> 3å›æ¥ç¨®</label>
                    <label><input type="radio" name="vaccine" value="4å›"> 4å›æ¥ç¨®</label>
                </div>
            </section>

            <!-- æœ‰è³‡æ ¼ãƒ»çµŒé¨“ -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">æœ‰è³‡æ ¼å–å¾—ãƒ»çµŒé¨“ä½œæ¥­</h2>
                <div class="mb-4">
                    <label>æœ‰è³‡æ ¼å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒ•ãƒˆã€æº¶æ¥ãªã©ï¼‰</label>
                    <textarea id="qualifications" rows="2"></textarea>
                </div>
                
                <h3 class="font-semibold mb-3">çµŒé¨“ä½œæ¥­å†…å®¹</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <label><input type="checkbox" name="exp" value="NCæ—‹ç›¤"> NCæ—‹ç›¤</label>
                    <label><input type="checkbox" name="exp" value="æ—‹ç›¤"> æ—‹ç›¤</label>
                    <label><input type="checkbox" name="exp" value="ãƒ—ãƒ¬ã‚¹"> ãƒ—ãƒ¬ã‚¹</label>
                    <label><input type="checkbox" name="exp" value="ãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒ•ãƒˆ"> ãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒ•ãƒˆ</label>
                    <label><input type="checkbox" name="exp" value="æ¢±åŒ…"> æ¢±åŒ…</label>
                    <label><input type="checkbox" name="exp" value="æº¶æ¥"> æº¶æ¥</label>
                    <label><input type="checkbox" name="exp" value="è»Šéƒ¨å“çµ„ç«‹"> è»Šéƒ¨å“çµ„ç«‹</label>
                    <label><input type="checkbox" name="exp" value="è»Šéƒ¨å“ãƒ©ã‚¤ãƒ³"> è»Šéƒ¨å“ãƒ©ã‚¤ãƒ³</label>
                    <label><input type="checkbox" name="exp" value="è»Šéƒ¨å“æ¤œæŸ»"> è»Šéƒ¨å“æ¤œæŸ»</label>
                    <label><input type="checkbox" name="exp" value="é›»å­éƒ¨å“æ¤œæŸ»"> é›»å­éƒ¨å“æ¤œæŸ»</label>
                    <label><input type="checkbox" name="exp" value="é£Ÿå“åŠ å·¥"> é£Ÿå“åŠ å·¥</label>
                    <label><input type="checkbox" name="exp" value="é‹³é€ "> é‹³é€ </label>
                    <label><input type="checkbox" name="exp" value="å¡—è£…"> å¡—è£…</label>
                    <label><input type="checkbox" value="ãƒ©ã‚¤ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼"> ãƒ©ã‚¤ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼</label>
                </div>
            </section>

            <!-- è·å‹™çµŒæ­´ -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">è·å‹™çµŒæ­´</h2>
                <div class="responsive-table">
                    <table>
                        <thead>
                            <tr>
                                <th>é–‹å§‹</th><th>çµ‚äº†</th><th>æ´¾é£å…ƒ</th><th>æ´¾é£å…ˆ</th><th>ä½œæ¥­å†…å®¹</th><th>é€€ç¤¾ç†ç”±</th><th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="job_history"></tbody>
                    </table>
                </div>
                <button onclick="addJobEntry()" class="mt-4 btn-secondary">è·æ­´è¿½åŠ </button>
            </section>

            <!-- å®¶æ—æ§‹æˆ -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">å®¶æ—æ§‹æˆ</h2>
                <div class="responsive-table">
                    <table>
                        <thead>
                            <tr><th>æ°å</th><th>ç¶šæŸ„</th><th>ç”Ÿå¹´æœˆæ—¥</th><th>å¹´é½¢</th><th>å±…ä½</th><th>æ‰¶é¤Š</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody id="family_members"></tbody>
                    </table>
                </div>
                <button onclick="addFamilyEntry()" class="mt-4 btn-secondary">å®¶æ—è¿½åŠ </button>
            </section>

            <!-- ãã®ä»– -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">ãã®ä»–</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>é€šå‹¤ç‰‡é“æ™‚é–“ï¼ˆåˆ†ï¼‰</label><input type="number" id="commute_time" placeholder="é€šå‹¤æ™‚é–“ã‚’å…¥åŠ›"></div>
                    <div>
                        <label>ãŠå¼å½“ï¼ˆç¤¾å†…é£Ÿå ‚ï¼‰</label>
                        <select id="lunch_pref" title="ãŠå¼å½“ã®é¸æŠ">
                            <option value="æ˜¼/å¤œ">æ˜¼/å¤œ</option>
                            <option value="æ˜¼ã®ã¿">æ˜¼ã®ã¿</option>
                            <option value="å¤œã®ã¿">å¤œã®ã¿</option>
                            <option value="æŒå‚">æŒå‚</option>
                        </select>
                    </div>
                </div>
            </section>

        </main>

        <footer class="mt-8 p-4 bg-white sticky bottom-0 border-t shadow-lg">
            <div class="flex justify-center gap-4">
                <button onclick="showPreview()" class="btn-secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                <button onclick="printPDF()" class="btn-primary">PDFå°åˆ·</button>
                <button onclick="saveData()" class="btn-secondary">ä¿å­˜</button>
            </div>
        </footer>
    </div>

    <!-- Preview Modal -->
    <div id="preview_modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; overflow: auto;">
        <div style="max-width: 1300px; margin: 20px auto; background: #ffffff; padding: 24px; border-radius: 12px; position: relative; box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);">
            <button onclick="closePreview()" style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; font-weight: bold;">Ã—</button>
            <h2 style="text-align: center; margin-bottom: 20px; color: #1D4ED8;">å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <div id="preview_content" style="border: 1px solid #cbd5f5; border-radius: 8px; min-height: 400px;"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="printPDF()" class="btn-primary">ã“ã®ã¾ã¾å°åˆ·</button>
            </div>
        </div>
    </div>

    <!-- Print Container -->
    <div id="print_container" style="display: none;"></div>

    <script>
        // ConfiguraciÃ³n global
        const CONFIG = {
            API_BASE_URL: window.location.origin.replace(/:\d+$/, ':8000'),
            DEBUG_MODE: false,
            OCR_ENDPOINTS: [
                '/api/candidates/ocr/process',
                '/api/azure-ocr/process'
            ]
        };
        
        // Initialize - ID comenzando desde UNS-2000
        document.getElementById('applicant_id').value = `UNS-2000`;
        let ocrCompleted = false;
        let wanakanaErrorLogged = false;
        let currentOCREndpoint = 0;
        
        // Comprobar estado del servidor al cargar la pÃ¡gina
        window.addEventListener('DOMContentLoaded', () => {
            checkServerStatus();
            checkOCREndpoint();
            initializeDateHandlers();
        });

        // FUNCIÃ“N: Formatear fecha a formato japonÃ©s (aÃ±o-mes-dÃ­a)
        function formatDateJapanese(dateString) {
            if (!dateString) return '';

            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;
        }

        // FUNCIÃ“N: Calcular edad automÃ¡ticamente desde fecha de nacimiento
        function calculateAge(birthDate) {
            if (!birthDate) return '';
            
            const today = new Date();
            const birth = new Date(birthDate);
            
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // FUNCIÃ“N: Inicializar manejadores de fechas
        function initializeDateHandlers() {
            // Manejador para el campo de fecha de nacimiento
            const birthdayInput = document.getElementById('birthday');
            if (birthdayInput) {
                birthdayInput.addEventListener('change', (event) => {
                    const birthDate = event.target.value;
                    const age = calculateAge(birthDate);
                    document.getElementById('age').value = age;
                    
                    console.log('Fecha de nacimiento (formato japonÃ©s):', formatDateJapanese(birthDate));
                });
            }
        }

        // FUNCIÃ“N: ConversiÃ³n de Romaji a Katakana
        function convertRomajiToFurigana(romajiText) {
            if (typeof wanakana === 'undefined') {
                if (!wanakanaErrorLogged) {
                    logDebug('WanaKana library not loaded. Autoconversion disabled.');
                    wanakanaErrorLogged = true;
                }
                return '';
            }

            if (!romajiText || !romajiText.trim()) {
                return '';
            }

            const normalizedInput = romajiText
                .normalize('NFKC')
                .replace(/[^A-Za-z\s\-']+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            if (!normalizedInput) {
                return '';
            }

            const manualWordMap = {
                'tu': 'ãƒˆã‚¥',
                'di': 'ãƒ‡ã‚£',
                'du': 'ãƒ‰ã‚¥',
                'fa': 'ãƒ•ã‚¡',
                'fi': 'ãƒ•ã‚£',
                'fe': 'ãƒ•ã‚§',
                'fo': 'ãƒ•ã‚©',
                'je': 'ã‚¸ã‚§',
                'we': 'ã‚¦ã‚§',
                'wi': 'ã‚¦ã‚£',
                'anh': 'ã‚¢ãƒ³'
            };

            const katakanaWords = normalizedInput.split(' ').map((word) => {
                if (!word) return '';

                const lowerWord = word.toLowerCase();
                if (manualWordMap[lowerWord]) {
                    return manualWordMap[lowerWord];
                }

                const sanitizedWord = lowerWord.replace(/nh$/g, 'n');
                let katakanaWord = wanakana.toKatakana(sanitizedWord);

                if (word.includes('-')) {
                    katakanaWord = katakanaWord.replace(/-/g, 'ãƒ»');
                }

                return katakanaWord;
            }).filter(Boolean);

            return katakanaWords.join('ã€€');
        }
        
        // FUNCIÃ“N: Actualizar automÃ¡ticamente ãƒ•ãƒªã‚¬ãƒŠ desde æ°å
        function autoUpdateFurigana(nameValue) {
            const value = (nameValue || '').trim();
            let convertMessage = '';
            let furiganaValue = '';

            // Si el nombre estÃ¡ en Romaji (solo letras latinas), convertir a Katakana
            if (value && /^[A-Za-z\s'-]+$/.test(value)) {
                furiganaValue = convertRomajiToFurigana(value);
                convertMessage = 'ãƒ­ãƒ¼ãƒå­—ã‹ã‚‰ãƒ•ãƒªã‚¬ãƒŠã«å¤‰æ›ã—ã¾ã—ãŸ';

                console.log(`ConversiÃ³n: "${value}" -> "${furiganaValue}"`);
            }
            // Si el nombre contiene Kana, copiar directamente a ãƒ•ãƒªã‚¬ãƒŠ
            else if (/[\u3040-\u309F\u30A0-\u30FF]/.test(value)) {
                furiganaValue = value;
                convertMessage = 'ã‚«ãƒŠã‚’ãƒ•ãƒªã‚¬ãƒŠã«è¨­å®šã—ã¾ã—ãŸ';
            }
            // Si el nombre contiene Kanji, intentar leerlo con la librerÃ­a
            else if (/[\u4E00-\u9FAF]/.test(value)) {
                furiganaValue = value;
                convertMessage = 'æ¼¢å­—ã®ãƒ•ãƒªã‚¬ãƒŠã‚’æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„';
            }
            else {
                furiganaValue = '';
                convertMessage = '';
            }

            // Actualizar el campo ãƒ•ãƒªã‚¬NA
            const furiganaField = document.getElementById('name_furigana');
            if (furiganaField) {
                furiganaField.value = furiganaValue;
            }

            const noteField = document.getElementById('ocr_note');
            if (noteField) {
                noteField.value = convertMessage;
            }

            return { furiganaValue, convertMessage };
        }

        // Event Listener para el campo de nombre (æ°å) que actualiza automÃ¡ticamente ãƒ•ãƒªã‚¬ãƒŠ
        const nameKanjiInput = document.getElementById('name_kanji');
        if (nameKanjiInput) {
            nameKanjiInput.addEventListener('input', (event) => {
                const nameValue = event.target.value;
                autoUpdateFurigana(nameValue);
            });
        }

        // FunciÃ³n de depuraciÃ³n
        function logDebug(message) {
            if (CONFIG.DEBUG_MODE) {
                console.log('[DEBUG]', message);
                const debugInfo = document.getElementById('debug_info');
                if (debugInfo) {
                    debugInfo.innerHTML += `<br>${new Date().toLocaleTimeString()}: ${message}`;
                    debugInfo.scrollTop = debugInfo.scrollHeight;
                }
            }
        }

        // FunciÃ³n para togglear el modo de depuraciÃ³n
        function toggleDebugMode() {
            CONFIG.DEBUG_MODE = !CONFIG.DEBUG_MODE;
            const debugInfo = document.getElementById('debug_info');
            if (debugInfo) {
                debugInfo.classList.toggle('hidden');
                if (CONFIG.DEBUG_MODE) {
                    debugInfo.innerHTML = 'Modo de depuraciÃ³n activado';
                    logDebug('Sistema operativo: ' + navigator.platform);
                    logDebug('Navegador: ' + navigator.userAgent);
                    logDebug('URL actual: ' + window.location.href);
                }
            }
        }

        // Comprobar estado del servidor
        async function checkServerStatus() {
            const serverStatus = document.getElementById('server_status');
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/`);
                if (response.ok) {
                    const data = await response.json();
                    serverStatus.textContent = `âœ… En lÃ­nea (${data.version})`;
                    serverStatus.className = 'font-semibold text-green-600';
                    logDebug('Servidor backend en lÃ­nea');
                } else {
                    throw new Error(`Status: ${response.status}`);
                }
            } catch (error) {
                serverStatus.textContent = `âŒ Error de conexiÃ³n`;
                serverStatus.className = 'font-semibold text-red-600';
                logDebug(`Error al conectar con el servidor: ${error.message}`);
            }
        }

        // Comprobar endpoint de OCR
        async function checkOCREndpoint() {
            const ocrStatus = document.getElementById('ocr_status');
            
            for (let i = 0; i < CONFIG.OCR_ENDPOINTS.length; i++) {
                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}${CONFIG.OCR_ENDPOINTS[i]}`, {
                        method: 'OPTIONS'
                    });
                    
                    if (response.ok || response.status === 405) {
                        ocrStatus.textContent = `âœ… Disponible (${CONFIG.OCR_ENDPOINTS[i]})`;
                        ocrStatus.className = 'font-semibold text-green-600';
                        currentOCREndpoint = i;
                        logDebug(`Endpoint OCR encontrado: ${CONFIG.OCR_ENDPOINTS[i]}`);
                        return;
                    }
                } catch (error) {
                    logDebug(`Error al verificar endpoint ${CONFIG.OCR_ENDPOINTS[i]}: ${error.message}`);
                }
            }
            
            ocrStatus.textContent = `âŒ No disponible`;
            ocrStatus.className = 'font-semibold text-red-600';
            logDebug('No se encontraron endpoints de OCR disponibles');
        }

        // Photo upload
        document.getElementById('photo_input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('photo_preview').src = event.target.result;
                    document.getElementById('photo_preview').classList.remove('hidden');
                    document.getElementById('photo_placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // OCR Processing
        document.getElementById('zairyu_card').addEventListener('change', (e) => processOCR(e, 'zairyu'));
        document.getElementById('license_card').addEventListener('change', (e) => processOCR(e, 'license'));

        // FunciÃ³n para verificar archivo y procesar
        async function checkFileAndProcess(file) {
            if (!file) {
                throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚(No file selected)');
            }

            if (!file.type.match('image.*')) {
                throw new Error('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚(Image files only)');
            }

            if (file.size > 5 * 1024 * 1024) {
                throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚(File must be under 5MB)');
            }

            try {
                const base64 = await fileToBase64(file);
                return base64;
            } catch (error) {
                console.error('File conversion error:', error);
                throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(Failed to read file)');
            }
        }

        // FunciÃ³n processOCR mejorada
        async function processOCR(event, type) {
            if (ocrCompleted) {
                logDebug('OCR processing already completed.');
                event.target.value = '';
                return;
            }

            const previewId = type === 'zairyu' ? 'zairyu_preview' : 'license_preview';
            const statusId = type === 'zairyu' ? 'zairyu_status' : 'license_status';
            const placeholderId = type === 'zairyu' ? 'zairyu_placeholder' : 'license_placeholder';
            
            const preview = document.getElementById(previewId);
            const status = document.getElementById(statusId);
            const placeholder = document.getElementById(placeholderId);

            try {
                const file = event.target.files[0];
                const base64Image = await checkFileAndProcess(file);
                
                // Mostrar preview
                preview.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
                placeholder.style.display = 'none';

                // Mostrar estado de procesamiento
                status.textContent = 'å‡¦ç†ä¸­... ãŠå¾…ã¡ãã ã•ã„';
                status.className = 'ocr-status processing';
                status.classList.remove('hidden');
                
                // AÃ±adir indicador visual de progreso
                let dots = 0;
                const processingInterval = setInterval(() => {
                    dots = (dots + 1) % 4;
                    status.textContent = 'å‡¦ç†ä¸­' + '.'.repeat(dots) + ' ãŠå¾…ã¡ãã ã•ã„';
                }, 500);

                // Intentar procesar con diferentes endpoints
                let textData = null;
                let lastError = null;
                
                for (let i = 0; i < CONFIG.OCR_ENDPOINTS.length; i++) {
                    try {
                        logDebug(`Intentando OCR con endpoint: ${CONFIG.OCR_ENDPOINTS[i]}`);
                        textData = await extractTextFromImage(base64Image, file.type, type, i);

                        if (textData && (textData.name_kanji || textData.extracted_text || textData.raw_text)) {
                            logDebug(`OCR exitoso con endpoint: ${CONFIG.OCR_ENDPOINTS[i]}`);
                            
                            // Normalizar datos del backend para compatibilidad
                            if (textData.name_kanji && !textData.name) {
                                textData.name = textData.name_kanji;
                            }
                            
                            break;
                        }
                    } catch (error) {
                        logDebug(`Error con endpoint ${CONFIG.OCR_ENDPOINTS[i]}: ${error.message}`);
                        lastError = error;

                        if (error.message.includes('Tiempo de espera agotado')) {
                            throw error;
                        }
                    }
                }

                if (!textData || (!textData.name && !textData.name_kanji && !textData.extracted_text)) {
                    const errorMsg = lastError ? lastError.message : 'ãƒ†ã‚­ã‚¹ãƒˆã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚(Failed to extract text or name)';
                    throw new Error(errorMsg);
                }

                // Rellenar campos del formulario
                document.getElementById('name_kanji').value = textData.name_kanji || textData.name || '';
                document.getElementById('birthday').value = textData.birthday || '';
                document.getElementById('address').value = textData.address || '';
                
                // Calcular edad automÃ¡ticamente desde la fecha de nacimiento
                if (textData.birthday) {
                    const calculatedAge = calculateAge(textData.birthday);
                    document.getElementById('age').value = calculatedAge;
                    console.log(`Edad calculada: ${calculatedAge} aÃ±os desde ${formatDateJapanese(textData.birthday)}`);
                }
                
                // Rellenar gÃ©nero si estÃ¡ disponible
                if (textData.gender) {
                    document.getElementById('gender').value = textData.gender;
                }
                
                // Rellenar nacionalidad si estÃ¡ disponible
                if (textData.nationality) {
                    const nationalitySelect = document.getElementById('nationality');
                    const options = nationalitySelect.options;
                    let found = false;
                    
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].text.includes(textData.nationality) ||
                            options[i].value.includes(textData.nationality)) {
                            nationalitySelect.value = options[i].value;
                            found = true;
                            break;
                        }
                    }
                    
                    if (!found) {
                        nationalitySelect.value = 'ãã®ä»–';
                    }
                }
                
                // Rellenar cÃ³digo postal si estÃ¡ disponible
                const postalField = document.getElementById('postal_code');
                if (postalField && textData.postal_code) {
                    postalField.value = textData.postal_code;
                }
                
                // Rellenar nÃºmero de tarjeta de residencia si estÃ¡ disponible
                if (textData.card_number) {
                    document.getElementById('residence_card_no').value = textData.card_number;
                }
                
                // Rellenar tipo de visa si estÃ¡ disponible
                if (textData.visa_type) {
                    document.getElementById('visa_type').value = textData.visa_type;
                }
                
                // Rellenar fecha de vencimiento de visa si estÃ¡ disponible
                if (textData.visa_expiry) {
                    const visaExpiryField = document.getElementById('visa_expiry');
                    if (visaExpiryField) {
                        visaExpiryField.value = textData.visa_expiry;
                    }
                }

                // Rellenar nÃºmero de pasaporte si estÃ¡ disponible
                if (textData.passport_number) {
                    document.getElementById('passport_no').value = textData.passport_number;
                }
                
                // Rellenar fecha de vencimiento de pasaporte si estÃ¡ disponible
                if (textData.passport_expiry) {
                    document.getElementById('passport_expiry').value = textData.passport_expiry;
                }

                if (textData.photo) {
                    document.getElementById('photo_preview').src = textData.photo;
                    document.getElementById('photo_preview').classList.remove('hidden');
                    document.getElementById('photo_placeholder').style.display = 'none';
                }

                // Auto-rellenar ãƒ•ãƒªã‚¬ãƒŠ (Furigana) desde OCR
                if (type === 'zairyu') {
                    autoUpdateFurigana(textData.name_kanji || textData.name || '');

                    if (textData.name_kana) {
                        document.getElementById('name_furigana').value = textData.name_kana;
                        const ocrNoteField = document.getElementById('ocr_note');
                        if (ocrNoteField) {
                            ocrNoteField.value = 'OCRã‹ã‚‰ã‚«ãƒŠã‚’å–å¾—ã—ã¦ãƒ•ãƒªã‚¬ãƒŠã«è¨­å®šã—ã¾ã—ãŸ\n' + (ocrNoteField.value || '');
                        }
                    }
                }

                clearInterval(processingInterval);
                
                ocrCompleted = true;
                status.textContent = 'âœ“ å‡¦ç†å®Œäº†ï¼';
                status.className = 'ocr-status success';

                // Deshabilitar otro input OCR
                const otherType = type === 'zairyu' ? 'license' : 'zairyu';
                document.getElementById(`${otherType}_card`).disabled = true;
                document.getElementById(`${otherType}_card`).closest('.ocr-upload-area').style.opacity = '0.5';

            } catch (error) {
                if (typeof processingInterval !== 'undefined') {
                    clearInterval(processingInterval);
                }
                
                console.error('OCR Error:', error);
                logDebug(`Error en OCR: ${error.message}`);
                
                let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'object') {
                    try {
                        errorMessage = JSON.stringify(error);
                    } catch (e) {
                        errorMessage = 'è©³ç´°ä¸æ˜ã®ã‚¨ãƒ©ãƒ¼';
                    }
                }
                
                status.textContent = `âœ— ${errorMessage}`;
                status.className = 'ocr-status error';
                event.target.value = '';
                
                setTimeout(() => {
                    status.innerHTML = `âœ— ${errorMessage}<br><small>æ‰‹å‹•ã§æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>`;
                }, 3000);
            }
        }

        // FunciÃ³n para convertir archivo a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = () => {
                    try {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    } catch (error) {
                        reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(Failed to convert file)'));
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(Failed to read file)'));
                };
                
                reader.readAsDataURL(file);
            });
        }

        // FunciÃ³n para extraer texto de imagen
        async function extractTextFromImage(base64Image, mimeType, type, endpointIndex = 0) {
            try {
                // Convertir base64 a Blob
                const response = await fetch(`data:${mimeType};base64,${base64Image}`);
                const blob = await response.blob();
                
                // Crear FormData
                const formData = new FormData();
                const documentType = type === 'license' ? 'license' : 'zairyu_card';

                formData.append('file', blob, 'document.jpg');
                formData.append('document_type', documentType);

                // Usar el endpoint especÃ­fico segÃºn el Ã­ndice
                const endpoint = CONFIG.OCR_ENDPOINTS[endpointIndex];
                logDebug(`Enviando imagen al backend: ${endpoint} con document_type=${documentType}`);

                // AÃ±adir timeout para evitar que se quede colgado
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const endpointUrl = `${CONFIG.API_BASE_URL}${endpoint}`;

                const apiResponse = await fetch(endpointUrl, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!apiResponse.ok) {
                    const errorData = await apiResponse.json().catch(() => ({}));
                    const errorMessage = errorData.detail || `Error ${apiResponse.status}`;
                    logDebug(`Error con ${endpoint}: ${errorMessage}`);
                    throw new Error(errorMessage);
                }
                
                const result = await apiResponse.json();
                
                if (!result.success) {
                    logDebug(`OCR fallÃ³ con ${endpoint}: ${result.message || 'Error desconocido'}`);
                    throw new Error(result.message || 'Error desconocido');
                }
                
                logDebug(`âœ“ OCR exitoso desde backend usando: ${endpoint}`);
                return result.data;
                
            } catch (error) {
                logDebug(`Error en extractTextFromImage: ${error.message}`);
                
                if (error.name === 'AbortError') {
                    throw new Error('Tiempo de espera agotado. IntÃ©ntelo de nuevo.');
                }
                
                throw error;
            }
        }

        // Add job entry
        function addJobEntry() {
            const tbody = document.getElementById('job_history');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="month" class="job-start"></td>
                <td><input type="month" class="job-end"></td>
                <td><input type="text" class="job-hakenmoto"></td>
                <td><input type="text" class="job-hakensaki"></td>
                <td><input type="text" class="job-content"></td>
                <td><input type="text" class="job-reason"></td>
                <td><button type="button" class="delete-btn" onclick="this.closest('tr').remove()">Ã—</button></td>
            `;
            tbody.appendChild(tr);
        }

        // Add family entry
        function addFamilyEntry() {
            const tbody = document.getElementById('family_members');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="fam-name"></td>
                <td><input type="text" class="fam-relation"></td>
                <td><input type="date" class="fam-birthday"></td>
                <td><input type="number" class="fam-age"></td>
                <td><input type="text" class="fam-residence"></td>
                <td><select class="fam-dependent"><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></td>
                <td><button type="button" class="delete-btn" onclick="this.closest('tr').remove()">Ã—</button></td>
            `;
            tbody.appendChild(tr);
        }

        // Collect all form data
        function collectFormData() {
            const jobHistory = [];
            document.querySelectorAll('#job_history tr').forEach(tr => {
                jobHistory.push({
                    start: tr.querySelector('.job-start')?.value || '',
                    end: tr.querySelector('.job-end')?.value || '',
                    hakenmoto: tr.querySelector('.job-hakenmoto')?.value || '',
                    hakensaki: tr.querySelector('.job-hakensaki')?.value || '',
                    content: tr.querySelector('.job-content')?.value || '',
                    reason: tr.querySelector('.job-reason')?.value || ''
                });
            });

            const familyMembers = [];
            document.querySelectorAll('#family_members tr').forEach(tr => {
                familyMembers.push({
                    name: tr.querySelector('.fam-name')?.value || '',
                    relation: tr.querySelector('.fam-relation')?.value || '',
                    birthday: tr.querySelector('.fam-birthday')?.value || '',
                    age: tr.querySelector('.fam-age')?.value || '',
                    residence: tr.querySelector('.fam-residence')?.value || '',
                    dependent: tr.querySelector('.fam-dependent')?.value || ''
                });
            });

            const experiences = [];
            document.querySelectorAll('input[name="exp"]:checked').forEach(cb => {
                experiences.push(cb.value);
            });

            return {
                photo: document.getElementById('photo_preview').src,
                name_kanji: document.getElementById('name_kanji').value,
                name_furigana: document.getElementById('name_furigana').value,
                applicant_id: document.getElementById('applicant_id').value,
                birthday: document.getElementById('birthday').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                nationality: document.getElementById('nationality').value,
                postal_code: document.getElementById('postal_code').value,
                address: document.getElementById('address').value,
                mobile: document.getElementById('mobile').value,
                phone: document.getElementById('phone').value,
                emergency_name: document.getElementById('emergency_name').value,
                emergency_relation: document.getElementById('emergency_relation').value,
                emergency_phone: document.getElementById('emergency_phone').value,
                ocr_note: document.getElementById('ocr_note').value,
                visa_type: document.getElementById('visa_type').value,
                visa_period: document.getElementById('visa_period').value,
                visa_expiry: document.getElementById('visa_expiry').value,
                residence_card_no: document.getElementById('residence_card_no').value,
                passport_no: document.getElementById('passport_no').value,
                passport_expiry: document.getElementById('passport_expiry').value,
                license_no: document.getElementById('license_no').value,
                license_type: document.getElementById('license_type').value,
                license_expiry: document.getElementById('license_expiry').value,
                car_owner: document.querySelector('input[name="car_owner"]:checked')?.value || '',
                insurance: document.querySelector('input[name="insurance"]:checked')?.value || '',
                speak_level: document.getElementById('speak_level').value,
                listen_level: document.getElementById('listen_level').value,
                kanji_level: document.getElementById('kanji_level').value,
                kana_read: document.getElementById('kana_read').value,
                kana_write: document.getElementById('kana_write').value,
                education: document.getElementById('education').value,
                major: document.getElementById('major').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                uniform_size: document.getElementById('uniform_size').value,
                waist: document.getElementById('waist').value,
                shoe_size: document.getElementById('shoe_size').value,
                blood_type: document.getElementById('blood_type').value,
                vision_right: document.getElementById('vision_right').value,
                vision_left: document.getElementById('vision_left').value,
                glasses: document.querySelector('input[name="glasses"]:checked')?.value || '',
                dominant_arm: document.querySelector('input[name="dominant_arm"]:checked')?.value || '',
                allergy: document.querySelector('input[name="allergy"]:checked')?.value || '',
                safety_shoes: document.querySelector('input[name="safety_shoes"]:checked')?.value || '',
                vaccine: document.querySelector('input[name="vaccine"]:checked')?.value || '',
                qualifications: document.getElementById('qualifications').value,
                experiences: experiences,
                jobHistory: jobHistory,
                familyMembers: familyMembers,
                commute_time: document.getElementById('commute_time').value,
                lunch_pref: document.getElementById('lunch_pref').value,
                // Nuevos campos extraÃ­dos por OCR
                region: document.getElementById('region').value,
                permission_date: document.getElementById('permission_date').value,
                issue_date: document.getElementById('issue_date').value,
                authorized_activity: document.getElementById('authorized_activity').value,
                employer_restriction: document.getElementById('employer_restriction').value
            };
        }

        // Utility functions for formatting
        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return value
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatValue(value, fallback = 'â€•') {
            const normalized = (value ?? '').toString().trim();
            return normalized ? escapeHtml(normalized) : fallback;
        }

        function formatValueWithUnit(value, unit, fallback = 'â€•') {
            const normalized = (value ?? '').toString().trim();
            return normalized ? `${escapeHtml(normalized)}${unit}` : fallback;
        }

        function formatMultiline(value, fallback = 'â€•') {
            const normalized = (value ?? '').toString().trim();
            return normalized ? escapeHtml(value).replace(/\n/g, '<br>') : fallback;
        }

        function formatPeriod(start, end) {
            const s = (start ?? '').toString().trim();
            const e = (end ?? '').toString().trim();
            if (!s && !e) return 'â€•';
            if (!s) return escapeHtml(e);
            if (!e) return escapeHtml(s);
            return `${escapeHtml(s)} ã€œ ${escapeHtml(e)}`;
        }

        // Show Preview
        function showPreview() {
            const modal = document.getElementById('preview_modal');
            const content = document.getElementById('preview_content');

            content.innerHTML = generatePrintHTML(false);
            modal.style.display = 'block';
        }

        function closePreview() {
            document.getElementById('preview_modal').style.display = 'none';
        }

        // Print with PDF
        function printPDF() {
            const printContainer = document.getElementById('print_container');
            printContainer.innerHTML = generatePrintHTML(true);

            // Usamos setTimeout para asegurar que el contenido se ha renderizado antes de imprimir
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function generatePrintHTML(forPrint) {
            const data = collectFormData();
            const jobRows = (data.jobHistory || [])
                .filter(job => [job.start, job.end, job.hakenmoto, job.hakensaki, job.content, job.reason].some(field => (field ?? '').toString().trim()))
                .map(job => `
                    <tr>
                        <td>${formatPeriod(job.start, job.end)}</td>
                        <td>${formatValue(job.hakenmoto)}</td>
                        <td>${formatValue(job.hakensaki)}</td>
                        <td>${formatValue(job.content)}</td>
                        <td>${formatValue(job.reason)}</td>
                    </tr>
                `)
                .join('');

            const familyRows = (data.familyMembers || [])
                .filter(member => [member.name, member.relation, member.birthday, member.age, member.residence, member.dependent].some(field => (field ?? '').toString().trim()))
                .map(member => `
                    <tr>
                        <td>${formatValue(member.name)}</td>
                        <td>${formatValue(member.relation)}</td>
                        <td>${formatValue(member.birthday)}</td>
                        <td>${formatValue(member.age)}</td>
                        <td>${formatValue(member.residence)}</td>
                        <td>${formatValue(member.dependent)}</td>
                    </tr>
                `)
                .join('');

            const experiencesTags = (data.experiences || []).length
                ? data.experiences.map(exp => `<span class="print-tag">${formatValue(exp)}</span>`).join('')
                : '<span class="print-muted">çµŒé¨“ä½œæ¥­ã®ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</span>';

            const photoContent = data.photo && data.photo !== window.location.href
                ? `<img src="${escapeHtml(data.photo)}" alt="å†™çœŸ">`
                : '<span class="print-muted">å†™çœŸæœªç™»éŒ²</span>';

            return `
                <div class="print-page">
                    <div class="print-header">
                        <div class="print-photo-frame">${photoContent}</div>
                        <table class="print-basic-table">
                            <tr>
                                <th>æ°å</th>
                                <td>${formatValue(data.name_kanji)}</td>
                                <th>ãƒ•ãƒªã‚¬ãƒŠ</th>
                                <td>${formatValue(data.name_furigana)}</td>
                            </tr>
                            <tr>
                                <th>ç”Ÿå¹´æœˆæ—¥</th>
                                <td>${formatValue(data.birthday)}</td>
                                <th>å¹´é½¢</th>
                                <td>${formatValueWithUnit(data.age, 'æ­³')}</td>
                            </tr>
                            <tr>
                                <th>æ€§åˆ¥</th>
                                <td>${formatValue(data.gender)}</td>
                                <th>å›½ç±</th>
                                <td>${formatValue(data.nationality)}</td>
                            </tr>
                            <tr>
                                <th>ID</th>
                                <td>${formatValue(data.applicant_id)}</td>
                                <th>å±…ä½åœ°åŸŸ</th>
                                <td>${formatValue(data.region)}</td>
                            </tr>
                        </table>
                    </div>

                    <div class="print-grid">
                        <section class="print-section">
                            <div class="print-section-title">ä½æ‰€ãƒ»é€£çµ¡å…ˆ</div>
                            <table class="print-table">
                                <tr><th>éƒµä¾¿ç•ªå·</th><td>${formatValue(data.postal_code)}</td></tr>
                                <tr><th>ä½æ‰€</th><td>${formatValue(data.address)}</td></tr>
                                <tr><th>æºå¸¯é›»è©±</th><td>${formatValue(data.mobile)}</td></tr>
                                <tr><th>é›»è©±ç•ªå·</th><td>${formatValue(data.phone)}</td></tr>
                                <tr>
                                    <th>ç·Šæ€¥é€£çµ¡å…ˆ</th>
                                    <td>
                                        <span class="block">${formatValue(data.emergency_name)}</span>
                                        <span class="block print-muted">ç¶šæŸ„: ${formatValue(data.emergency_relation)}</span>
                                        <span class="block print-muted">é›»è©±: ${formatValue(data.emergency_phone)}</span>
                                    </td>
                                </tr>
                            </table>
                        </section>

                        <section class="print-section">
                            <div class="print-section-title">åœ¨ç•™ãƒ»èº«åˆ†è¨¼æƒ…å ±</div>
                            <table class="print-table">
                                <tr><th>åœ¨ç•™è³‡æ ¼</th><td>${formatValue(data.visa_type)}</td></tr>
                                <tr><th>åœ¨ç•™æœŸé–“</th><td>${formatValue(data.visa_period)}</td></tr>
                                <tr><th>åœ¨ç•™æœŸé–“æº€äº†æ—¥</th><td>${formatValue(data.visa_expiry)}</td></tr>
                                <tr><th>è³‡æ ¼å¤–æ´»å‹•è¨±å¯æ—¥</th><td>${formatValue(data.permission_date)}</td></tr>
                                <tr><th>äº¤ä»˜æ—¥</th><td>${formatValue(data.issue_date)}</td></tr>
                                <tr><th>è³‡æ ¼å¤–æ´»å‹•</th><td>${formatMultiline(data.authorized_activity)}</td></tr>
                                <tr><th>å°±åŠ´åˆ¶é™</th><td>${formatMultiline(data.employer_restriction)}</td></tr>
                                <tr><th>åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå·</th><td>${formatValue(data.residence_card_no)}</td></tr>
                                <tr><th>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·</th><td>${formatValue(data.passport_no)}</td></tr>
                                <tr><th>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆæœ‰åŠ¹æœŸé™</th><td>${formatValue(data.passport_expiry)}</td></tr>
                            </table>
                        </section>

                        <section class="print-section">
                            <div class="print-section-title">é‹è»¢ãƒ»ä¿é™º</div>
                            <table class="print-table">
                                <tr><th>é‹è»¢å…è¨±è¨¼ç•ªå·</th><td>${formatValue(data.license_no)}</td></tr>
                                <tr><th>å…è¨±ç¨®é¡</th><td>${formatValue(data.license_type)}</td></tr>
                                <tr><th>å…è¨±æœ‰åŠ¹æœŸé™</th><td>${formatValue(data.license_expiry)}</td></tr>
                                <tr><th>è»Šä¸¡æ‰€æŒ</th><td>${formatValue(data.car_owner)}</td></tr>
                                <tr><th>è‡ªå‹•è»Šä¿é™º</th><td>${formatValue(data.insurance)}</td></tr>
                            </table>
                        </section>

                        <section class="print-section">
                            <div class="print-section-title">æ—¥æœ¬èªåŠ›ãƒ»å­¦æ­´</div>
                            <table class="print-table">
                                <tr><th>ä¼šè©±</th><td>${formatValue(data.speak_level)}</td></tr>
                                <tr><th>è´è§£</th><td>${formatValue(data.listen_level)}</td></tr>
                                <tr><th>æ¼¢å­—</th><td>${formatValue(data.kanji_level)}</td></tr>
                                <tr><th>ã‚«ãƒŠèª­</th><td>${formatValue(data.kana_read)}</td></tr>
                                <tr><th>ã‚«ãƒŠæ›¸</th><td>${formatValue(data.kana_write)}</td></tr>
                                <tr><th>æœ€çµ‚å­¦æ­´</th><td>${formatValue(data.education)}</td></tr>
                                <tr><th>å°‚æ”»</th><td>${formatValue(data.major)}</td></tr>
                            </table>
                        </section>

                        <section class="print-section">
                            <div class="print-section-title">èº«ä½“æƒ…å ±ãƒ»å¥åº·çŠ¶æ…‹</div>
                            <table class="print-table">
                                <tr><th>èº«é•·</th><td>${formatValueWithUnit(data.height, 'cm')}</td></tr>
                                <tr><th>ä½“é‡</th><td>${formatValueWithUnit(data.weight, 'kg')}</td></tr>
                                <tr><th>æœã‚µã‚¤ã‚º</th><td>${formatValue(data.uniform_size)}</td></tr>
                                <tr><th>ã‚¦ã‚¨ã‚¹ãƒˆ</th><td>${formatValueWithUnit(data.waist, 'cm')}</td></tr>
                                <tr><th>é´ã‚µã‚¤ã‚º</th><td>${formatValueWithUnit(data.shoe_size, 'cm')}</td></tr>
                                <tr><th>è¡€æ¶²å‹</th><td>${formatValue(data.blood_type)}</td></tr>
                                <tr><th>è¦–åŠ›(å³)</th><td>${formatValue(data.vision_right)}</td></tr>
                                <tr><th>è¦–åŠ›(å·¦)</th><td>${formatValue(data.vision_left)}</td></tr>
                                <tr><th>ãƒ¡ã‚¬ãƒ</th><td>${formatValue(data.glasses)}</td></tr>
                                <tr><th>åˆ©ãè…•</th><td>${formatValue(data.dominant_arm)}</td></tr>
                                <tr><th>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</th><td>${formatValue(data.allergy)}</td></tr>
                                <tr><th>å®‰å…¨é´</th><td>${formatValue(data.safety_shoes)}</td></tr>
                                <tr><th>ãƒ¯ã‚¯ãƒãƒ³</th><td>${formatValue(data.vaccine)}</td></tr>
                            </table>
                        </section>

                        <section class="print-section">
                            <div class="print-section-title">å‹¤å‹™æ¡ä»¶ãƒ»å‚™è€ƒ</div>
                            <table class="print-table">
                                <tr><th>é€šå‹¤ç‰‡é“æ™‚é–“</th><td>${formatValueWithUnit(data.commute_time, 'åˆ†')}</td></tr>
                                <tr><th>ãŠå¼å½“/é£Ÿå ‚</th><td>${formatValue(data.lunch_pref)}</td></tr>
                                <tr><th>ç‰¹è¨˜äº‹é …</th><td>${formatMultiline(data.ocr_note)}</td></tr>
                            </table>
                        </section>

                        <section class="print-section full-width">
                            <div class="print-section-title">ä¿æœ‰è³‡æ ¼ãƒ»çµŒé¨“ä½œæ¥­</div>
                            <table class="print-table" style="margin-bottom: 4mm;">
                                <tr><th>æœ‰è³‡æ ¼</th><td>${formatMultiline(data.qualifications)}</td></tr>
                            </table>
                            <div class="print-tags">${experiencesTags}</div>
                        </section>
                    </div>

                    <section class="print-section" style="margin-bottom: 8mm;">
                        <div class="print-section-title">è·å‹™çµŒæ­´</div>
                        <table class="print-table">
                            <thead>
                                <tr>
                                    <th>æœŸé–“</th>
                                    <th>æ´¾é£å…ƒ</th>
                                    <th>æ´¾é£å…ˆ</th>
                                    <th>ä½œæ¥­å†…å®¹</th>
                                    <th>é€€ç¤¾ç†ç”±</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${jobRows || '<tr><td colspan="5" style="text-align: center;" class="print-muted">è·å‹™çµŒæ­´ã®ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>'}
                            </tbody>
                        </table>
                    </section>

                    <section class="print-section">
                        <div class="print-section-title">å®¶æ—æ§‹æˆ</div>
                        <table class="print-table">
                            <thead>
                                <tr>
                                    <th>æ°å</th>
                                    <th>ç¶šæŸ„</th>
                                    <th>ç”Ÿå¹´æœˆæ—¥</th>
                                    <th>å¹´é½¢</th>
                                    <th>å±…ä½</th>
                                    <th>æ‰¶é¤Š</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${familyRows || '<tr><td colspan="6" style="text-align: center;" class="print-muted">å®¶æ—æ§‹æˆã®ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>'}
                            </tbody>
                        </table>
                    </section>
                </div>
            `;
        }

        // Map form data to backend schema
        function mapFormDataToBackendSchema(formData) {
            return {
                full_name_kanji: formData.name_kanji,
                full_name_kana: formData.name_furigana,
                date_of_birth: formData.birthday || null,
                gender: formData.gender,
                nationality: formData.nationality,
                postal_code: formData.postal_code,
                current_address: formData.address,
                mobile: formData.mobile,
                phone: formData.phone,
                residence_status: formData.visa_type,
                residence_expiry: formData.visa_expiry || null,
                residence_card_number: formData.residence_card_no,
                passport_number: formData.passport_no,
                passport_expiry: formData.passport_expiry || null,
                license_number: formData.license_no,
                license_expiry: formData.license_expiry || null,
                car_ownership: formData.car_owner,
                voluntary_insurance: formData.insurance,
                major: formData.major,
                commute_time_oneway: formData.commute_time ? parseInt(formData.commute_time) : null
            };
        }

        // Save Data
        async function saveData() {
            const formData = collectFormData();
            const mappedData = mapFormDataToBackendSchema(formData);

            // Validar campos obligatorios
            if (!mappedData.full_name_kanji) {
                alert('æ°åã¯å¿…é ˆé …ç›®ã§ã™ã€‚(Name is required)');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/candidates/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(mappedData),
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Â¡Datos guardados en la base de datos correctamente!');
                    console.log(result);

                    // Limpiar formulario despuÃ©s de guardar
                    document.getElementById('name_kanji').value = '';
                    document.getElementById('name_furigana').value = '';
                    document.getElementById('birthday').value = '';
                    document.getElementById('age').value = '';
                    document.getElementById('address').value = '';
                    // Limpiar otros campos si es necesario

                    // Resetear estado de OCR
                    ocrCompleted = false;
                    document.getElementById('zairyu_card').disabled = false;
                    document.getElementById('zairyu_card').closest('.ocr-upload-area').style.opacity = '1';
                    document.getElementById('license_card').disabled = false;
                    document.getElementById('license_card').closest('.ocr-upload-area').style.opacity = '1';
                    document.getElementById('zairyu_status').classList.add('hidden');
                    document.getElementById('license_status').classList.add('hidden');
                    document.getElementById('zairyu_preview').classList.add('hidden');
                    document.getElementById('zairyu_placeholder').style.display = 'flex';
                    document.getElementById('license_preview').classList.add('hidden');
                    document.getElementById('license_placeholder').style.display = 'flex';
                } else {
                    alert('Error al guardar los datos: ' + (result.detail || 'Error desconocido'));
                    console.error('Error from server:', result);
                }
            } catch (error) {
                alert('Error de conexiÃ³n con el servidor. AsegÃºrate de que estÃ© corriendo.');
                console.error('Fetch error:', error);
            }
        }
    </script>
</body>
</html>